---
title: "Bareground"
output:
  pdf_document: default
  word_document: default
  html_document:
    df_print: paged
header-includes:
- \usepackage[width=\textwidth]{caption}
- \usepackage{wrapfig}
always_allow_html: yes
csl: ../citations/citations/apa.csl
bibliography: ../citations/citations/citations.bib
link-citations: yes
---

\vspace{-1cm}

A decrease in the total amount of vegetation, the litter associated with dead portions which fall away from it, and soil crusts, leads to an increase in bare ground. Bare ground, constitutes the top layer of all soil which may be exposed to a falling raindrop, and in addition to vegetation does not include rock and gravel. Increases in bare ground increase the susceptibility of soil to erosion, a process which adversely impacts both natural and human modified areas (SECTION X.X). While invasive species tend to drastically alter the biotic context of ecological sites (SECTION X.X), and different plant functional groups (SECTION X.X.) have differing effects on decreasing the potential of soil to erosion (SECTION X.X), the alteration of functional groups and shifting of an ecological site to cover  of noxious species is not a zero sum game for soil retention. Accordingly, here we determine whether an appropriate amount of vegetation, and biocrusts, remain on sites to prevent an increase in the risk of sites to erodibility. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(dpi = 300) 
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(fig.align="left") 
```

# Methods

TerrAdat summary data were downloaded from the ArcMap SDE (Spatial Database Engine) service layer on February 9th 2023, and imported into R. The references for bare ground cover come exclusively from the 'Reference Sheet' portion as Ecological Site Descriptions as these values were noted to differ from vegetation estimates in a few of the functional cover estimates. These estimates were available for XX of all the XX sites which had plots verified to them,  XX of XX  total plots had a reference benchmark.  

```{r}
library(tidyverse)
library(sf)
library(spsurvey)



prop_fail <- function(x){
  
  meet <- table(x$Meeting)
  toString(paste0('proportion of plots not achieving benchmarks: ', round( meet[1] / sum(meet), 3), 
         ' (n = ',  sum(meet), ')' ))
}

mround <- function(x, base){ base*round(x/base) }

# pv_reporter <- function(x){ # push to elements and finally finish this up on day, but back burn 
  # now! so sad. 
  
#   row <- nrow(s[["coefficients"]])
#  p <- s[["coefficients"]][row,4]
  
#  p_report <- if(p < 0.0001)
#  {'p < 0.0001'} else (p < 0.001)
#  {'p < 0.001'} else (paste0('p = ', p))
  
#  strength <-  if(p < 0.001)
#  {'The data revealed very strong evidence '} else (p < 0.01)
#  {'The data revealed moderate'} else(p < 0.05)
#  {'There was weak evidence'} else(p <0.1)
  
#}


```

```{r Import AIM Data}
praw <- '../data/raw'
#ppro <-  '../data/processed'
f <- list.files(praw, pattern = 'csv')
#files <- list.files(ppro, pattern = 'csv')


# combine the plots with their weights from the sample design
coords <- read.csv(file.path(praw, f[grep('coordinates', f)]) ) %>% 
  st_as_sf(coords = c('xcoord', 'ycoord'), crs = 4269) %>% 
  filter(Plot.Status == 'sampled') %>% 
  select(-Panel, -Plot.Status) %>% 
  mutate(Stratum = str_remove(str_extract(Plot.ID, '^.*-'), '-'), 
         .before = geometry) %>% 
  rename(PLOTID = Plot.ID) %>% 
  mutate(PLOTID = str_trim(PLOTID)) 

wghts <- read.csv(file.path(praw, f[grep('Weights', f)]) ) %>% 
  select(Stratum, AoInference = Area, WghtPerPlot) %>% 
  left_join(coords, wghts, by = c('Stratum', 'AoInference'))  %>% 
  drop_na()

# combine the plot level data to their ESDs benchmarks. 
benchmarks <- read.csv(file.path(praw, f[grep('ESD.*benchmarks', f)]) ) %>% 
  pivot_longer(!ECO.SITE, names_to = 'ESTIMATE', values_to = 'PERCENT')

ecosites <- read.csv(file.path(praw, f[grep('Tracking.*ESD', f)]) ) %>% 
  drop_na(ECO.SITE) %>% 
  select(-PANEL, -STATUS) %>% 
  left_join(., benchmarks, by = 'ECO.SITE') %>% 
  rename(PLOTID = PLOT.ID)

# import and subset TerrAdat summary data
summary <- read.csv(file.path(praw, f[grep('TerraDat', f)])) %>% 
  select(PrimaryKey, PlotID, BareSoilCover, TotalFoliarCover, ) %>% 
  mutate(PlotID = str_replace(PlotID, 'PJW', 'PJ'),
         PlotID = str_replace(PlotID, 'RIP', 'RI'),
         PlotID = str_replace(PlotID, 'Other', 'OT')) %>% 
  rename(PLOTID = PlotID) %>% 
  left_join(wghts, ., by = 'PLOTID') 
  

rm(coords,  wghts)
```


```{r join terradat to plot data}

known_ecosites <- ecosites %>%
  filter(ECO.SITE.MATCHED == T, ESTIMATE == 'UPPER') %>% 
  drop_na() %>% 
  left_join(., summary, by = 'PLOTID') %>% 
  mutate(Meeting = if_else(BareSoilCover <= PERCENT, T, F),
         .after = BareSoilCover) %>% 
  st_as_sf()

```


```{r Compare Total Foliar Estimatess}

esg_unverified_plots <- read.csv(file.path(praw, f[grep('ESG_unverified', f)])) %>% 
  mutate(ESG = str_replace(ESG, '_-_', '-')) %>% 
  rename(PLOTID = 'PLOT.ID') %>% 
  mutate(ESG = str_replace(ESG, 'SAC-Loamy_Uplands', 'SAC-Finer_Uplands'),
         ESG = str_replace(ESG, 'SAW-Outcrops', 'Outcrops'), 
         ESG = str_replace(ESG, 'SAW-Bottoms', 'SAW-Saline_Bottoms'), 
         ESG = str_replace(ESG, 'SAW-Shallow$', 'SAW-Shallow_and_Deep_Rocky'),
         ESG = str_replace(ESG, 'AW-Loamy_Uplands', 'AW-Sandy_and_Loamy_Uplands'))

lkp_abb <- data.frame(
  Climate =
    c('Arid_Warm', 'Semiarid_Cool',  'Semiarid_warm', 'No_Climate_Group'),
  Abbrev = c('AW', 'SAC', 'SAW', "")
)

esg_cover <- read.csv(file.path(praw, f[grep('SiteGroup', f)])) %>% 
  select(Climate, SoilGeomorphicUnits, PERCENT = Total_Foliar) %>% 
  left_join(., lkp_abb) %>% 
  unite('ESG', c('Abbrev', 'SoilGeomorphicUnits'), sep = '-') %>% 
  select(-Climate) %>% 
  mutate(ESG = str_remove(ESG, '^-'), 
         ESG = str_replace(ESG, 'AW-Sandy_Bottoms', 'AW-Bottoms'),
         ESG = str_replace(ESG, 'SAC-Saline_Sandy_Loamy_Finer_Uplands', 
                           'SAC-Finer_Uplands')
         ) 

esg_bm <- left_join(esg_unverified_plots, esg_cover, by = 'ESG') %>% 
  rename(ECO.SITE = ESG)

esg_bm <- ecosites %>% 
  filter(ECO.SITE.MATCHED == F) %>% 
  select(-PERCENT, -ECO.SITE, PLOTID) %>% 
  mutate(ESTIMATE = 'LOWER') %>% 
  full_join(., esg_bm, by = 'PLOTID')

rm(lkp_abb, esg_unverified_plots)
```

```{r join ESG data to plots with ESDs which do NOT have reference metrics developed yet}

esg_lkp_tab <- read.csv(file.path(praw, f[grep('ESG-Lookup', f)])) %>% 
  left_join(., esg_cover ) 

es_wo_d <- ecosites %>%
  filter(ECO.SITE.MATCHED == T, ESTIMATE == 'UPPER', is.na(PERCENT)) %>% 
  left_join(., summary, by = 'PLOTID') %>% 
  select(-PERCENT) %>%  
  left_join(., esg_lkp_tab) %>% 
  mutate(Meeting = if_else(TotalFoliarCover >= PERCENT, T, F),
         .after = BareSoilCover) %>% 
  select(-ESG)

rm(ecosites, esg_cover, esg_lkp_tab)
```

```{r reassemble all plots now with metrics}

esd <- known_ecosites %>% drop_na()

esg <- esg_bm %>% 
  left_join(., summary, by = 'PLOTID') %>% 
  mutate(Meeting = if_else(TotalFoliarCover >= PERCENT, T, F),
         .after = BareSoilCover) %>% 
  st_as_sf()

esg_bm <- bind_rows(es_wo_d, esg)

rm(summary)
```


```{r Does Total Foliar Cover Predict Bare Soil ?}
 
s <- summary(
  bg_pred_tfc <-  lm(BareSoilCover ~ TotalFoliarCover, data = known_ecosites)
  )
# plot(bg_pred_tfc$residuals) # fine for purposes
# abline(0,0)

# par(mfrow  = c(2,2))
# plot(bg_pred_tfc )
# par(mfrow = c(1,1))

newdat <- data.frame(TotalFoliarCover =  100:0 )
predicted_vals <- predict(bg_pred_tfc, newdat, tyep = 'response', se.fit = T) 
newdat = data.frame(
  TotalFoliarCover = newdat$TotalFoliarCover, 
  BareSoilCover = predicted_vals$fit, 
  se.low = predicted_vals$fit - predicted_vals$se.fit,
  se.high = predicted_vals$fit + predicted_vals$se.fit
)

par(pty="s")
plot( x = known_ecosites$TotalFoliarCover, y = known_ecosites$BareSoilCover,
     xlab = 'Total Foliar Cover', ylab = 'Bare Soil Cover',  axes = FALSE, 
     main = 'Predicting Bareground from Foliar Cover',
     xlim = c(0,100), ylim = c(0,100), col = rgb(red = 0, green = 0, blue = 0, alpha = 0.3))
lines(x = newdat$TotalFoliarCover, y = newdat$BareSoilCover,  lwd = 2) 
lines(y = newdat$se.high, x = newdat$TotalFoliarCover,  col = 'red', lwd = 2, lty = 3)
lines(y = newdat$se.low, x = newdat$TotalFoliarCover,  col = 'red', lwd = 2, lty = 3)
axis(1)
axis(2, las = 1)

rm(predicted_vals, bg_pred_tfc)
```


The Ecological Site Groups do not contain values for bare ground cover, however they do contain the mean value of 'Total Foliar Cover' for each AIM plot within the concept. In order to generate a realistic estimate of Bare ground for these plots, we assume that a relationship exists between the total foliar cover at a plot, and the proportion of bare ground. While the true relationship is expressed in the equation below:

$$ 100 - (\text{foliar cover} + \text{litter} +  \text{rock} + \text{biocrusts})) = \text{bare ground} $$
We sought to simplify this relationship to:

$$ 100 -  \text{foliar cover} = \text{bare ground} $$
In order to accomplish this a very simple linear model was created, using the `r ` AIM plots which had both verified Ecological Sites, and which these contained descriptions with cover reference. The linear model used the TerrAdat metric 'TotalFoliarCover' as a predictor of 'BareSoilCover' $\text{lm(BareSoilCover ~ TotalFoliarCover)}$ (in R modelling parlance), *STATS.* The values predicted from this model, for estimates of Total Foliar Cover from 0-100 were then rounded up to the nearest 5, e.g. an estimate of 1% bare ground would be 5%, to reflect variation in reference states, and that a linear model seeks to pass through the central *MOTION* of a cloud of data points.  

We compared the results from three different calculations of benchmarks. The first values utilizing the benchmarks from the Ecological Site Descriptions, resulted in a Field Office wide `r prop_fail(known_ecosites)`, while for plots with matched Ecological Sites, but which lacked a written Description `r prop_fail(es_wo_d)`, and plots which were not mapped to an Ecological Site `r prop_fail(esg)`. Taken together all plots compared with esgs had `r prop_fail(esg_bm2)`

Based on these data, their was very strong evidence that foliar cover affects bare ground (adj. r^2^ = `r round(s[["adj.r.squared"]], 3)`, p < 000.1), and that we can safely simplify this relationship. 

```{r compare imputed benchmarks to raw benchmarks}

newdat <- newdat %>%
  select(TotalFoliarCover, BareSoilCover) %>%
  mutate(
    Imputed_Target_LM = if_else(BareSoilCover < 5, 5, BareSoilCover),
    Imputed_Target_5 = if_else(BareSoilCover < 5, 5, BareSoilCover),
    Imputed_Target_10 = if_else(BareSoilCover < 10, 10, BareSoilCover),
    Imputed_Target_5 = mround(Imputed_Target_5, base = 5),
    Imputed_Target_10 = mround(Imputed_Target_10, base = 10)
  ) %>% 
  select(-BareSoilCover)

# round up values to the nearest 5, we have 2-3 which are missed by just a few tenths
# of a percent, and we could catch them here, but realistically these should
# convey the heterogeneity of a system better. 

esg_bm <- drop_na(esg_bm)

compare_imputed <- esg_bm %>% 
  select(TotalFoliarCover, BareSoilCover, PERCENT) %>% 
  mutate(TotalFoliarCover = round(TotalFoliarCover, 0)) %>% 
  left_join(., newdat, by = 'TotalFoliarCover') %>% 
  mutate(
    Meeting_TF = if_else(TotalFoliarCover <= PERCENT, T, F), 
    Meeting_IT = if_else(BareSoilCover <= Imputed_Target_LM, T, F), 
    Meeting_IT_5 = if_else(BareSoilCover <= Imputed_Target_5, T, F), 
    Meeting_IT_10 = if_else(BareSoilCover <= Imputed_Target_10, T, F)
    ) %>% 
  select(starts_with('Meeting')) %>% 
  summarize(across(.cols = everything(), sum, na.rm = T)) %>% 
  mutate(across(.cols = everything(), ~ 1 - (.x/nrow(esg_bm))))


ref <- known_ecosites %>% 
  st_drop_geometry() %>% 
  select(Meeting_ESD = Meeting) %>% 
  summarize(across(.cols = everything(), sum, na.rm = T)) %>% 
   mutate(across(.cols = everything(), ~ 1 - (.x/nrow(known_ecosites))))
  
cbind(compare_imputed, ref) %>% 
  t() %>% 
  data.frame() %>% 
  rownames_to_column() %>% 
  rename(condition = 1, Percent = 2) %>% 
  mutate(Type = case_when(
    str_detect(condition, 'TF') ~ 'ESG',
    str_detect(condition, 'ESD') ~ 'ESD',
    str_detect(condition, 'IT') ~ 'Imputed'
    )) %>% 
  ggplot(aes(x = fct_reorder(condition, -Percent), y = Percent, fill = Type)) +
  geom_col() +
  theme_bw() +
  scale_x_discrete(labels=c('Total Foliar', 'LM', 'LM + 5%',
                            'ESD',  'LM + 10%')) +
  scale_fill_manual(values = c('#D4CB92', '#395C6B', '#BCD3F2')) +
  geom_text(aes(label = round(Percent, 3))) + 

  labs(title = 'Comparision of ESG with ESG derived Benchmarks', 
       x = 'Calculated Value', y = 'Proportion of Plots Meeting Benchmark')

newdat <- select(newdat, TotalFoliarCover, Imputed_Target_10)
```

We compare four possible benchmark values inferred from the ESG covers. The first was the original value of Total Foliar Cover, using this metric `r paste0(round(compare_imputed[1, 'Meeting_TF'], 3) * 100, '%')` plots were classified as failing to meet benchmarks, a serious discrepancy, `r paste0(round((compare_imputed[1, 'Meeting_TF'] - ref[1,1])  * 100, 1), '%')`, between those plots which had ESD benchmarks to compare themselves to which had only `r paste0(round(ref[1,1], 3) * 100, '%')` plots failing to achieve benchmarks. The linear model was a serious improvement over these results decreasing the discrepancy between the plots with known benchmarks which were failing and the linear model predictions of plots failing, `r paste0(round(compare_imputed[1, 'Meeting_IT'], 3) * 100, '%')`, to 
`r paste0(round((compare_imputed[1, 'Meeting_IT'] - ref[1,1])  * 100, 1), '%')`.

Turning the predictions from the linear model into more 'human like' results, by creating intervals within the range via rounding, more akin to how humans report estimates, proved to improve upon the linear model estimates. Both values used for a buffer offset, 5% and 10%, produced results with a similar accuracy to the AIM plots with known benchmarks. When using the buffer of 5% a difference of `r paste0(abs(round(ref[1,1] - compare_imputed[1, 'Meeting_IT_5'], 3) * 100), '%')` was observed, and with 10% a difference of `r paste0(abs(round(ref[1,1] - compare_imputed[1, 'Meeting_IT_10'], 3) * 100), '%')` was also observed. While several prominent information theories, and model evaluation approaches would support the acceptance of the 5% buffer, due to a great number of the plots in the groups under evaluation being in Major Land Resource Area (MLRA) 48. This area is generally very well vegetated, and we expect it to have more land within reference relative to the remainder of the field office. 

```{r link all results back together with better benchmarks}

esg_bm <- esg_bm %>% 
  left_join(., newdat, by = c('PERCENT' = 'TotalFoliarCover')) %>% 
  mutate(Meeting = if_else(BareSoilCover <= Imputed_Target_10, T, F),
         .after = BareSoilCover) %>% 
  select(-PERCENT) %>% 
  rename(PERCENT = Imputed_Target_10) %>% 
  mutate(SET = 'ESG')

plots_w_bm <- esd %>% 
  mutate(SET = 'ESD') %>% 
  bind_rows(., esg_bm) %>% 
  st_as_sf() %>% 
  drop_na() %>% 
  select(-ESTIMATE, -TotalFoliarCover)

rm(esd, es_wo_d, esg, ref, compare_imputed, esg_bm, newdat, s, mround, known_ecosites)
```


```{r run cat analysis}

bareground <- spsurvey::cat_analysis(
  dframe = plots_w_bm, siteID = 'PLOTID', vars = 'Meeting',
  subpops = 'AoInference',  weight = 'WghtPerPlot', vartype = 'Local', conf = 80)

```

```{r create figure of cover by ESD}

  ggplot(data = plots_w_bm) +
  
  geom_jitter( height = 0.2,
              aes(x = BareSoilCover, y = fct_reorder(ECO.SITE, PERCENT)), alpha = 0.4) +
  geom_point(aes(x = PERCENT, y = fct_reorder(ECO.SITE, PERCENT), color  = SET), 
            shape = 18, alpha = 0.8, size = 3) + #benchmarks here

  theme_bw() + # AIM data are here
  
  scale_color_manual('Benchmark', 
                     values = c("ESD" = '#66A182', "ESG" = "#C0D461")) +
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid.major.y =  element_blank(),
        axis.text.y = element_text(size = 7, angle = 45), 
        aspect.ratio = 16/9,
        legend.position = 'bottom') +
  labs(title = 'Bareground',
       y = NULL, x = 'Percent') +
  scale_x_continuous(NULL, breaks = seq(from = 0, to = 60, by = 10), 
                     labels = paste0(seq(from = 0, to = 60, by = 10), '%'), 
                     limits = c(0,60))
ggsave(plot = last_plot(), device = 'png', height = 21, units = 'cm', 
       path = '../results', filename = 'bareground_benchmarks.png')

```

```{r figure of cover by administrative area}

noxious_presence_analysis <- noxious_presence_analysis %>% 
  mutate(Method = 'SR_Presence')
waff_dat <- noxious_cover_analysis %>% 
  mutate(Method = 'LPI_Presence') %>% 
  bind_rows(noxious_presence_analysis, .) %>% 
  filter(Category == T) 
waff_dat <- waff_dat %>% 
  mutate(
    across(where(is.numeric), ~ round(.x, 0)),
    Low = if_else(LCB80Pct.P == 0, 0, LCB80Pct.P - 1),
    CI_Low = Estimate.P - LCB80Pct.P,
    Estimate = 1,
    CI_High = UCB80Pct.P - Estimate.P,
    High = if_else(UCB80Pct.P == 0, 100, 100 - UCB80Pct.P)
  ) %>% 
  rowwise(Subpopulation) %>% 
  mutate(High = if_else(sum(c_across(Low:High)) > 100, High -1, High),
         High = if_else(sum(c_across(Low:High)) < 100, High + 1, High))  %>% 
  select(Subpopulation, Method,  Low:High) %>% 
  pivot_longer(cols = Low:High, names_to = 'Statistic', values_to = 'Value') %>% 
  group_by(Subpopulation) %>% 
  mutate(
    Method = factor(Method, levels = c('SR_Presence', 'LPI_Presence')),
    Statistic = factor(Statistic,
                       levels = c('Low', 'CI_Low', 'Estimate', 'CI_High', 'High')), 
    Subpopulation = factor(Subpopulation,
                       levels = c('ACEC-WSA', 'DE-NM', 'GG-NM', 'SampleFrame')))
waff_dat <- data.table::setorder(waff_dat, Statistic)
waf_values = c('Low' = '#1FE032', 'High' = '#E0321F', 'CI_Low' = '#808929', 
               'Estimate' = 'black', 'CI_High' = '#808929')
meth_labs = setNames(c("Richness", "LPI"), c('SR_Presence', "LPI_Presence"))
w <- ggplot(waff_dat, aes(fill = Statistic, values = Value)) +
  geom_waffle(color = "white", size = .25, flip = TRUE) +
  facet_wrap( ~ Subpopulation, 
             labeller = labeller(Method = meth_labs)) +
  scale_fill_manual('Condition', values = waf_values, 
                    labels = c('Meeting', 'Conf. Int.', "Estimate", 'Conf. Int.', 'Failing')) +
  scale_x_discrete()  +
  scale_y_continuous('Percent Land', labels = function(x)round(x * 10, -1), expand = c(0,0))  +
  
  theme(
    legend.position="bottom", legend.direction="vertical",
    aspect.ratio = 1,
    axis.text.y = element_text(color = "grey20", size = 6, angle = 45),
    axis.title.y = element_text(size = 9),
    legend.key.size = unit(0.3, 'lines'),
    legend.text = element_text(size = 6),
    legend.title = element_text(hjust = 0.5, size = 8), 
    plot.title = element_text(hjust = 0.5, size = 10, face = 'bold'),
    panel.spacing = unit(0.4, "lines"), 
    strip.background =element_rect(fill="white"), 
    panel.background = element_blank()) +
  guides(fill=guide_legend(ncol=2))
ggsave(w, path = '../results/figures', device = 'png', bg = 'transparent',
       filename = 'waffles.png', dpi = 300, height = 4, units = "in")
```


```{sh, crop the images, eval = F}
cd ../results/benchmarks
mogrify -trim *.png
```

# Results

The percent bare ground is relatively ... 

\begin{wrapfigure}{l}{0.5\textwidth}
  \centering
    \includegraphics[width=0.5\textwidth]{../results/bareground_benchmark.png}
  \caption{Benchmarks and Observed Values}
\end{wrapfigure}

# References